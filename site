#######################
- hosts: http
  tasks:
#######################
#Backup site to ansible machine to /root
    - name: "backup"
      tags: backup  
      synchronize:
        mode: pull
        src: /var/www/template2
        dest: /root/site2_template2
        rsync_opts:
          - "--ignore-existing"
#Backup config sites
    - name: "backup config"
      tags: backup
      synchronize:
        mode: pull
        src: /etc/apache2/sites-available/site2.conf
        dest: /root/config_sites
        rsync_opts:
          - "--ignore-existing" 
#Diactivational sites
    - name: "diactivatioal sites"
      command: a2dissite site2.conf
      ignore_errors: true
#Copy config sites
    - name: "copy config 2 sites"
      copy:
        src: /etc/site2.conf
        dest: /etc/apache2/sites-available/
#Copy files sites
    - name: "copy sites 2"
      tags: str
      copy:
        src: /home/ishenko/template2
        dest: /var/www/
#Activational sites
    - name: "activation sites 2"
      command:  a2ensite site2.conf
#Configtest
    - name: "CONFIGTEST"
      command: apache2ctl configtest
      register: configtest
      ignore_errors: true
#Diactivational sites
    - name: "diactivational sites"
      command: a2dissite site2.conf
      ignore_errors: true
#Copy the old config
    - name: "Copy the old config"
      when: configtest|failed
      copy:
        src: /root/site2.conf
        dest: /etc/apache2/sites-available/
#Activation sites
    - name: "activation sites 2"
      command: a2ensite site2.conf
#Restart service apache2
    - name: "restart apache2"
      tags: a2re
      service:
        name: apache2
        state: restarted
